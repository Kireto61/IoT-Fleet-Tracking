\documentclass[12pt]{article}

\usepackage{cmap} % Fixes search and copy-paste for Cyrillic in PDF
\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[bulgarian]{babel}

% --- Typography ---
\usepackage{tempora} % Better Times New Roman clone with full Cyrillic support
\usepackage[top=3.5cm, bottom=2.5cm, left=3.0cm, right=2.0cm, a4paper]{geometry}
\usepackage{setspace}
\setstretch{1.5} % 1.5 line spacing
\usepackage[none]{hyphenat} % No hyphenation
\usepackage[expansion=false]{microtype} % Better text spacing and overflow prevention
\emergencystretch=1.5em % Help with line breaks in no-hyphenation environment
\sloppy
\usepackage{indentfirst} % Indent first paragraph after section
\setlength{\parindent}{1.25cm}
\setlength{\parskip}{0pt}

% --- Page Numbering (Bottom Right) ---
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\fancyfoot[R]{\thepage}

% --- Header for all pages except first ---
\usepackage{multirow}
\fancyhead[R]{%
  \scriptsize
  \begin{tabular}[t]{@{}r@{\hspace{0.3cm}}c@{}}
    Проект по дисциплина „Нерелационни бази данни" & \multirow{2}{*}{\raisebox{-0.5\height}{\includegraphics[height=2em]{images/ту.png}}} \\
    2025-2026 &
  \end{tabular}%
}

% --- Footnotes ---
\usepackage[hang,flushmargin]{footmisc}
\usepackage{ragged2e}
\renewcommand{\footnotelayout}{\fontsize{10}{12}\selectfont\setstretch{1.0}\justifying}

% --- Section Formatting ---
\usepackage{titlesec}
\newcommand{\sectionbreak}{\clearpage}

% Numbering style
\renewcommand{\thesection}{\Roman{section}}
\renewcommand{\thesubsection}{\arabic{section}.\arabic{subsection}}
\renewcommand{\thesubsubsection}{\arabic{section}.\arabic{subsection}.\arabic{subsubsection}}

% Sections: Roman, Bold, 14pt, Centered, Uppercase
\titleformat{\section}[block]
  {\fontsize{14}{16.8}\bfseries\centering}
  {\thesection. }
  {0pt}
  {\MakeUppercase}

% Paragraphs: Arabic, Bold, 14pt, 1.25cm indent
\titleformat{\subsection}[block]
  {\fontsize{14}{16.8}\bfseries}
  {\thesubsection. }
  {0pt}
  {}
\titlespacing*{\subsection}{1.25cm}{*3}{*2}

% Sub-paragraphs: Bold, 13pt, 2.0cm indent
\titleformat{\subsubsection}[block]
  {\fontsize{13}{15.6}\bfseries}
  {\thesubsubsection. }
  {0pt}
  {}
\titlespacing*{\subsubsection}{2.0cm}{*2}{*1}

% TOC uppercase patches
\usepackage{etoolbox}
\makeatletter
\patchcmd{\l@section}{#1}{\MakeUppercase{#1}}{}{}
\makeatother
\usepackage[titles]{tocloft}
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cftsubsecleader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cftsubsubsecleader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cftsecfont}{\fontsize{12}{14}\bfseries}
\renewcommand{\cftsecpagefont}{\fontsize{12}{14}\bfseries}
\renewcommand{\cftsecaftersnum}{.}
\renewcommand{\cftsubsecaftersnum}{.}
\renewcommand{\cftsubsubsecaftersnum}{.}

% --- Captions (Tables & Figures) ---
\usepackage{caption}
\DeclareCaptionLabelFormat{tablelabel}{Таблица #2}
\captionsetup[table]{
    labelformat=tablelabel, 
    labelsep=period, 
    font={bf,small}, % small is ~11pt in 12pt document
    justification=centering, 
    singlelinecheck=true
}
\DeclareCaptionLabelFormat{figurelabel}{Фигура #2}
\captionsetup[figure]{
    labelformat=figurelabel, 
    labelsep=period, 
    font={bf,small}, 
    justification=centering,
    singlelinecheck=true
}

% --- Other Essential Packages (Restored from original) ---
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{float}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{multirow}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{tikz}
\usetikzlibrary{decorations.pathreplacing,positioning,shapes.geometric}
\usepackage{siunitx}
\usepackage{textcomp}
\usepackage{gensymb}
\usepackage{fancyvrb}
\usepackage{eurosym}
\usepackage{soul}
\usepackage{subcaption}
\usepackage{enumerate}
\usepackage{enumitem}
\usepackage{adjustbox}

% --- Single Spacing Fixes ---
% Reset to single spacing for common non-text environments
\AtBeginEnvironment{tikzpicture}{\setstretch{1.1}}
\AtBeginEnvironment{lstlisting}{\setstretch{1.1}}
\AtBeginEnvironment{verbatim}{\setstretch{1.1}}
\AtBeginEnvironment{tabular}{\setstretch{1.1}}
\AtBeginEnvironment{tabu}{\setstretch{1.1}}
\AtBeginEnvironment{longtable}{\setstretch{1.1}}

% Global TikZ overflow fix: wrap in adjustbox
\BeforeBeginEnvironment{tikzpicture}{\begin{adjustbox}{max width=\textwidth}}
\AfterEndEnvironment{tikzpicture}{\end{adjustbox}}

% --- Code Highlighting ---
\definecolor{cppblue}{RGB}{0,0,180}
\definecolor{cppgreen}{RGB}{0,128,0}
\definecolor{cppred}{RGB}{180,0,0}
\definecolor{cppgray}{RGB}{128,128,128}

% Use a slightly more compact font for code to prevent horizontal overflow
% \usepackage[scaled=0.85]{couriers} % Removed because it lacks Cyrillic support, leading to spacing issues in code blocks
\usepackage[T2A]{fontenc} % Ensure T2A is available for the default typewriter font

% Define JavaScript language for listings
\lstdefinelanguage{JavaScript}{
  keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break, const, let, async, await, class, extends, static, import, export, from, default, throw, try, finally},
  keywordstyle=\color{cppblue}\bfseries,
  ndkeywords={class, export, boolean, throw, implements, import, this, interface, public, private, protected, package, void, number, string, boolean},
  ndkeywordstyle=\color{cppblue}\bfseries,
  identifierstyle=\color{black},
  sensitive=false,
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
  commentstyle=\color{cppgreen},
  stringstyle=\color{cppred},
  morestring=[b]',
  morestring=[b]"
}

\lstset{
    language=C++,
    basicstyle=\small\ttfamily,
    breaklines=true,
    breakatwhitespace=true,
    columns=fullflexible, % Better width handling for mono fonts
    keepspaces=true,
    xleftmargin=1.5em,
    xrightmargin=0.5em,
    keywordstyle=\color{cppblue}\bfseries,
    stringstyle=\color{cppred},
    commentstyle=\color{cppgreen}, % Removed itshape as it often causes spacing issues with Cyrillic
    identifierstyle=\color{black},
    showstringspaces=false,
    numbers=left,
    numberstyle=\tiny\color{cppgray},
    numbersep=8pt,
    aboveskip=1.5em,
    belowskip=1.5em,
    frame=single,
    framerule=0.5pt,
    rulecolor=\color{cppgray},
    tabsize=4,
    captionpos=b,
    morekeywords={co_await, co_return, co_yield, Task, expected, unexpected, requires, concept, constexpr, noexcept, nullptr, override, final},
    emph={Request, Response, Handler, Middleware, Router, App, Connection, WebSocketConnection, IoContext},
    emphstyle=\color{cppblue},
    columns=fullflexible,
    inputencoding=utf8,
    literate={а}{{\cyra}}1 {б}{{\cyrb}}1 {в}{{\cyrv}}1 {г}{{\cyrg}}1 {д}{{\cyrd}}1
             {е}{{\cyre}}1 {ж}{{\cyrzh}}1 {з}{{\cyrz}}1 {и}{{\cyri}}1 {й}{{\cyrishrt}}1
             {к}{{\cyrk}}1 {л}{{\cyrl}}1 {м}{{\cyrm}}1 {н}{{\cyrn}}1 {о}{{\cyro}}1
             {п}{{\cyrp}}1 {р}{{\cyrr}}1 {с}{{\cyrs}}1 {т}{{\cyrt}}1 {у}{{\cyru}}1
             {ф}{{\cyrf}}1 {х}{{\cyrh}}1 {ц}{{\cyrc}}1 {ч}{{\cyrch}}1 {ш}{{\cyrsh}}1
             {щ}{{\cyrshch}}1 {ъ}{{\cyrhrdsn}}1 {ь}{{\cyrsftsn}}1 {ю}{{\cyryu}}1 {я}{{\cyrya}}1
             {А}{{\CYRA}}1 {Б}{{\CYRB}}1 {В}{{\CYRV}}1 {Г}{{\CYRG}}1 {Д}{{\CYRD}}1
             {Е}{{\CYRE}}1 {Ж}{{\CYRZH}}1 {З}{{\CYRZ}}1 {И}{{\CYRI}}1 {Й}{{\CYRISHRT}}1
             {К}{{\CYRK}}1 {Л}{{\CYRL}}1 {М}{{\CYRM}}1 {Н}{{\CYRN}}1 {О}{{\CYRO}}1
             {П}{{\CYRP}}1 {Р}{{\CYRR}}1 {С}{{\CYRS}}1 {Т}{{\CYRT}}1 {У}{{\CYRU}}1
             {Ф}{{\CYRF}}1 {Х}{{\CYRH}}1 {Ц}{{\CYRC}}1 {Ч}{{\CYRCH}}1 {Ш}{{\CYRSH}}1
             {Щ}{{\CYRSHCH}}1 {Ъ}{{\CYRHRDSN}}1 {Ь}{{\CYRSFTSN}}1 {Ю}{{\CYRYU}}1 {Я}{{\CYRYA}}1,
}

\begin{document}

% --- Title Page ---
\begin{titlepage}
\thispagestyle{empty}
\begin{center}
    % Title header with images extending beyond margins
    \noindent
    \makebox[0pt]{%
      \makebox[\paperwidth][c]{%
        \raisebox{-0.5\height}{\includegraphics[width=0.2\linewidth]{images/ту.png}}%
        \hspace{0.5cm}%
        \raisebox{0.15\height}{\fontsize{18}{21.6}\selectfont Технически Университет - София}%
        \hspace{0.5cm}%
        \raisebox{-0.5\height}{\includegraphics[width=0.2\linewidth]{images/fcst.png}}%
      }%
    }

    \vspace{3.5cm}
    
    {\fontsize{20}{24}\selectfont 
    Интелигентна система за управление на автопарк с IoT интеграция
    \par}
        
    {\fontsize{14}{16.8}\selectfont курсова работа по\\„Нерелационни бази данни“\par}
    
    \vfill
    
    \begin{flushleft}
    Имена на студент: Кирил Вълков\par
    Факултетен номер: 121222194\par
    Група: 41\par
    Специалност: \textbf{Компютърно и софтуерно инженерство}\par
    Образователно-квалификационна степен: \textbf{бакалавър}\par
    \end{flushleft}
    
    {\fontsize{12}{14.4}\selectfont София, \today \par}
\end{center}
\end{titlepage}

\newpage
\pagenumbering{roman}
\tableofcontents
\newpage

\pagenumbering{arabic}
\input{chapters/Main.tex}

\end{document}

